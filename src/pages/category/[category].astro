---
import MainLayout from "../../layouts/MainLayout.astro";
import BlogPostPreview from "../../components/BlogPostPreview.astro";
import Sidebar from "../../components/Sidebar.astro";

export async function getStaticPaths() {
  const posts = await Astro.glob('../blog/*.md');

  // Extract all categories from all posts
  const allCategories = new Set();
  posts.forEach(post => {
    const categories = post.frontmatter.categories || [];
    categories.forEach(category => {
      allCategories.add(category);
    });
  });

  // Create a path for each category
  return Array.from(allCategories).map(category => {
    const filteredPosts = posts.filter(post =>
      post.frontmatter.categories &&
      post.frontmatter.categories.includes(category)
    );

    return {
      params: { category: category.toLowerCase().replace(/\s+/g, '-') },
      props: {
        category,
        posts: filteredPosts
      }
    };
  });
}

const { category, posts } = Astro.props;

// Sort posts by date
const sortedPosts = posts.sort(
  (a, b) => new Date(b.frontmatter.pubDate).valueOf() - new Date(a.frontmatter.pubDate).valueOf()
);

const title = `${category} - RunFun Blog`;
const description = `Blog posts about ${category} - RunFun Blog`;
---

<MainLayout title={title} description={description}>
  <div class="max-w-container mx-auto px-4">
    <div class="flex flex-col md:flex-row gap-8 py-8">
      <!-- Sidebar -->
      <aside class="w-full md:w-80 flex-shrink-0">
        <Sidebar currentCategory={category} />
      </aside>

      <!-- Main Content -->
      <main class="min-w-0 flex-grow">
        <div class="flex justify-between items-center mb-8">
          <h1 class="text-3xl md:text-4xl text-secondary m-0">{category}</h1>
          <a href="/categories" class="text-primary no-underline font-medium hover:underline">View all categories</a>
        </div>

        {sortedPosts.length === 0 ? (
          <p>No posts found in this category. Check back soon!</p>
        ) : (
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6 md:gap-8">
            {sortedPosts.map((post) => (
              <BlogPostPreview
                title={post.frontmatter.title}
                description={post.frontmatter.description}
                pubDate={new Date(post.frontmatter.pubDate)}
                url={post.url}
                heroImage={post.frontmatter.heroImage}
                categories={post.frontmatter.categories}
              />
            ))}
          </div>
        )}
      </main>
    </div>
  </div>
</MainLayout>

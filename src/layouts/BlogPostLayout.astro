---
import MainLayout from "./MainLayout.astro";
import type { CollectionEntry } from "astro:content";

interface Props {
  title: string;
  description?: string;
  pubDate: Date | string;
  updatedDate?: Date | string;
  heroImage?: string;
  categories?: string[];
}

const { title, description, pubDate, updatedDate, heroImage, categories } = Astro.props;

// Format date or use a fallback
function formatDate(date: Date | string | undefined) {
  if (!date) return '';

  const dateObj = date instanceof Date ? date : new Date(date);

  if (isNaN(dateObj.getTime())) {
    return String(date);
  }

  return dateObj.toLocaleDateString('en-us', {
    year: 'numeric',
    month: 'long',
    day: 'numeric',
  });
}

const formattedPubDate = formatDate(pubDate);
const formattedUpdatedDate = formatDate(updatedDate);

// Get ISO string safely
function toISOSafe(date: Date | string | undefined) {
  if (!date) return '';

  const dateObj = date instanceof Date ? date : new Date(date);

  if (isNaN(dateObj.getTime())) {
    return '';
  }

  return dateObj.toISOString();
}

const pubDateISO = toISOSafe(pubDate);
const updatedDateISO = toISOSafe(updatedDate);
---
---

<MainLayout title={title} description={description}>
  <article class="mb-12">
    {heroImage && <img src={import.meta.env.BASE_URL + heroImage.replace(/^\//, '')} alt={title} class="w-full h-auto rounded-lg mb-6 object-cover max-h-[400px]" />}

    <h1 class="text-4xl mb-2">{title}</h1>

    <div class="text-gray-600 text-sm mb-8">
      <time datetime={pubDateISO}>Published on {formattedPubDate}</time>
      {updatedDate && (
        <div class="mt-2 italic">
          <time datetime={updatedDateISO}>
            Updated on {formattedUpdatedDate}
          </time>
        </div>
      )}
      {categories && categories.length > 0 && (
        <div class="mt-3 flex items-center gap-2">
          <span>Categories: </span>
          <ul class="flex list-none p-0 m-0 gap-2 flex-wrap">
            {categories.map((category) => (
              <li class="m-0">
                <a href={`/category/${category.toLowerCase().replace(/\s+/g, '-')}`} class="inline-block bg-primary text-white px-2 py-1 rounded text-xs no-underline transition-colors hover:bg-secondary">{category}</a>
              </li>
            ))}
          </ul>
        </div>
      )}
    </div>

    <div class="post-content leading-relaxed [&_h2]:text-3xl [&_h2]:my-8 [&_h2]:mt-4 [&_h3]:text-2xl [&_h3]:my-6 [&_h3]:mt-4 [&_img]:max-w-full [&_img]:h-auto [&_img]:rounded [&_blockquote]:border-l-4 [&_blockquote]:border-gray-300 [&_blockquote]:pl-4 [&_blockquote]:italic [&_blockquote]:my-6 [&_blockquote]:text-gray-600 [&_pre]:bg-gray-50 [&_pre]:p-4 [&_pre]:rounded [&_pre]:overflow-x-auto [&_pre]:my-6 [&_code]:bg-gray-50 [&_code]:px-1 [&_code]:py-0.5 [&_code]:rounded [&_code]:text-sm">
      <slot />
    </div>
  </article>
</MainLayout>
